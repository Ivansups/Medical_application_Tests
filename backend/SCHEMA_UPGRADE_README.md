# Обновление схемы базы данных - Упрощение

## Обзор изменений

Схема базы данных была упрощена для улучшения производительности и упрощения поддержки кода.

## Ключевые изменения

### 1. Удалена таблица `test_results`
- **Причина**: Избыточность данных - результаты можно вычислять из `test_attempts` и `user_answers`
- **Влияние**: Уменьшено количество таблиц с 6 до 5
- **Преимущества**: Меньше JOIN операций, проще миграции

### 2. Упрощена структура `user_answers`
- **Было**: `answer_data` (JSON) - общее поле для всех типов ответов
- **Стало**: 
  - `selected_options` (JSON) - индексы выбранных вариантов
  - `text_answer` (TEXT) - текстовые ответы
  - `points_earned` (INTEGER) - полученные баллы

### 3. Добавлено поле `status` в `test_attempts`
- **Значения**: `in_progress`, `completed`, `abandoned`
- **Преимущества**: Лучшее отслеживание состояния попытки

### 4. Добавлено поле `is_active` в `tests`
- **Назначение**: Возможность деактивировать тесты без удаления
- **Преимущества**: Лучшее управление контентом

### 5. Упрощены роли пользователей
- **Было**: `student`, `teacher`, `admin`
- **Стало**: `student`, `admin`
- **Причина**: Роль `teacher` не использовалась активно

## Применение изменений

### 1. Запуск миграции

```bash
# Активировать виртуальную среду
source venv/bin/activate

# Применить миграцию
alembic upgrade head
```

### 2. Проверка изменений

```sql
-- Проверить, что таблица test_results удалена
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' AND table_name = 'test_results';

-- Проверить новые поля в tests
\d tests

-- Проверить новые поля в test_attempts
\d test_attempts

-- Проверить новые поля в user_answers
\d user_answers
```

### 3. Обновление кода

Все модели SQLAlchemy уже обновлены:
- ✅ `User` - убрана связь с `TestResult`
- ✅ `Test` - добавлено поле `is_active`
- ✅ `TestAttempt` - добавлено поле `status`
- ✅ `UserAnswer` - обновлена структура полей
- ✅ `Question` - без изменений

### 4. Обновление API

Схемы Pydantic обновлены:
- ✅ `TestCreate` - добавлено поле `is_active`
- ✅ `TestAttemptResponse` - добавлены поля `max_score`, `status`
- ✅ `UserAnswerCreate` - новые поля для ответов
- ✅ `UserAnswerResponse` - полная схема ответа

## Обратная совместимость

### Что изменилось для API:

1. **Создание тестов**: Добавлено поле `is_active` (опциональное, по умолчанию `true`)
2. **Ответы на вопросы**: Изменена структура с `answer_data` на `selected_options`/`text_answer`
3. **Попытки тестов**: Добавлено поле `status`

### Что осталось без изменений:

1. **Аутентификация**: Без изменений
2. **Основные CRUD операции**: Без изменений
3. **Структура вопросов**: Без изменений

## Откат изменений

Если потребуется откат:

```bash
# Откатить миграцию
alembic downgrade -1
```

Это восстановит:
- Таблицу `test_results`
- Старую структуру `user_answers`
- Удалит новые поля из `tests` и `test_attempts`

## Преимущества новой схемы

1. **Производительность**: Меньше таблиц = меньше JOIN операций
2. **Простота**: Проще понимать и поддерживать код
3. **Гибкость**: Легче добавлять новые функции
4. **Надежность**: Меньше дублирования данных
5. **Масштабируемость**: Лучшая производительность при росте данных

## Тестирование

После применения изменений рекомендуется:

1. **Запустить тесты API** (если есть)
2. **Проверить создание тестов** с новым полем `is_active`
3. **Проверить прохождение тестов** с новыми полями статуса
4. **Проверить сохранение ответов** с новой структурой

## Поддержка

При возникновении проблем:

1. Проверить логи приложения
2. Проверить структуру базы данных
3. Убедиться, что все миграции применены
4. Проверить соответствие моделей и схем
